---
import LayoutTaVue from "../layouts/LayoutTaVue.astro";
import svgRaw from "@/assets/lunettes.svg?raw";
---
<LayoutTaVue title="Configurateur — TaVue">
  <div class="grid lg:grid-cols-[1fr_420px] gap-8 items-start">
    <!-- PREVIEW -->
    <section class="card bg-base-100 border shadow-xl">
      <div class="card-body">
        <div class="flex items-center justify-between">
          <h2 class="card-title">Prévisualisation en temps réel</h2>
          <div class="tabs tabs-boxed">
            <a class="tab tab-active">Face</a>
            <a class="tab">Profil</a>
            <a class="tab">3/4</a>
          </div>
        </div>
        <div class="aspect-[4/3] rounded-box bg-base-200 grid place-items-center">
          <div id="svg-host" class="w-[90%] h-[90%]"></div>
        </div>
        <div class="mt-4 flex items-center justify-between">
          <div>
            <div class="opacity-70 text-sm">Modèle</div>
            <div class="text-xl font-semibold" id="model-name">TaVue Classic</div>
          </div>
          <div class="text-2xl font-semibold"><span id="price">289</span> €</div>
        </div>
      </div>
    </section>

    <!-- OPTIONS PANEL -->
    <aside class="card bg-base-100 border shadow-xl max-h-[calc(100vh-200px)]">
      <div class="card-body overflow-y-auto space-y-6">

        <!-- Matériau monture -->
        <div>
          <h3 class="font-semibold mb-2">Matériau de la monture</h3>
          <div id="mat-monture" class="grid grid-cols-2 gap-2"></div>
        </div>

        <!-- Couleur monture -->
        <div>
          <h3 class="font-semibold mb-2">Couleur de la monture</h3>
          <div id="col-monture" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="divider"></div>

        <!-- Matériau branches -->
        <div>
          <h3 class="font-semibold mb-2">Matériau des branches</h3>
          <div id="mat-branches" class="grid grid-cols-2 gap-2"></div>
        </div>

        <!-- Couleur branches -->
        <div>
          <h3 class="font-semibold mb-2">Couleur des branches</h3>
          <div id="col-branches" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="divider"></div>

        <!-- Dimensions -->
        <div>
          <label class="form-control">
            <div class="label"><span class="label-text">Largeur du pont: <span id="val-pont">18</span> mm</span></div>
            <input id="pont" type="range" min="14" max="22" value="18" class="range" />
          </label>
        </div>
        <div>
          <label class="form-control">
            <div class="label"><span class="label-text">Taille des verres: <span id="val-verres">52</span> mm</span></div>
            <input id="verres" type="range" min="48" max="58" value="52" class="range" />
          </label>
        </div>

        <!-- IA card -->
        <div class="card bg-base-200">
          <div class="card-body gap-3">
            <h4 class="font-semibold">Génération par Intelligence Artificielle</h4>
            <p class="text-sm opacity-70">Décrivez vos préférences (bureau, soirée, vélo…)</p>
            <textarea class="textarea textarea-bordered" placeholder="Ex : une monture élégante pour le bureau, avec des tons chauds"></textarea>
            <button class="btn btn-outline btn-primary">Générer avec l’IA</button>
          </div>
        </div>

        <!-- Résumé -->
        <div class="card bg-base-100 border">
          <div class="card-body gap-2">
            <h4 class="font-semibold">Résumé de votre configuration</h4>
            <ul class="text-sm opacity-80 space-y-1">
              <li>Matériau monture : <span id="sum-monture">Acétate</span></li>
              <li>Matériau branches : <span id="sum-branches">Acétate</span></li>
              <li>Largeur du pont : <span id="sum-pont">18</span> mm</li>
              <li>Taille des verres : <span id="sum-verres">52</span> mm</li>
            </ul>
            <div class="flex items-center justify-between pt-2">
              <div class="text-xl font-semibold"><span id="price-2">289</span> €</div>
              <div class="join">
                <button id="save" class="btn btn-outline join-item">Sauvegarder</button>
                <a href="/commande" class="btn btn-primary join-item">Commander</a>
              </div>
            </div>
          </div>
        </div>

      </div>
    </aside>
  </div>

  <!-- JS vanilla (couleurs/matériaux/prix) -->
  <script type="module">
    const COLORS = ["#2C3E50","#8B7355","#C9A885","#111827","#ffffff","#b91c1c","#065f46","#1e3a8a"];
    const MATS = ["Acétate","Métal","Titane","Bois"];
    const SURCHARGES = { "Acétate": {m:0,b:0}, "Métal": {m:30,b:20}, "Titane": {m:60,b:40}, "Bois": {m:45,b:35} };

    const state = {
      base: 289, matMonture: "Acétate", matBranches: "Acétate",
      colMonture: COLORS[0], colBranches: COLORS[1],
      largeurPont: 18, tailleVerres: 52,
      svg: `<?xml version="1.0"?>${svgRaw}`
    };

    const $ = (id) => document.getElementById(id);
    function price(){ return state.base + (SURCHARGES[state.matMonture].m||0) + (SURCHARGES[state.matBranches].b||0); }

    function injectSVG(){
      const host = $("svg-host");
      host.innerHTML = state.svg;
      host.querySelectorAll("svg *").forEach(el => el.setAttribute("stroke", state.colMonture));
    }

    function renderChips(containerId, list, current, onPick){
      const box = $(containerId); box.innerHTML = "";
      list.forEach(v=>{
        const b = document.createElement("button");
        b.type="button"; b.className = "btn "+(current===v?"btn-primary":"btn-outline"); b.textContent=v;
        b.onclick=()=>{ onPick(v); update(); }; box.appendChild(b);
      });
    }
    function renderDots(containerId, current, onPick, ring="ring ring-primary"){
      const box=$(containerId); box.innerHTML="";
      COLORS.forEach(c=>{
        const b=document.createElement("button"); b.type="button";
        b.className="w-7 h-7 rounded-full border"; b.style.background=c;
        if(current===c) b.className+=" "+ring; b.onclick=()=>{ onPick(c); update(); };
        box.appendChild(b);
      });
    }
    function update(){
      injectSVG();
      renderChips("mat-monture", MATS, state.matMonture, (v)=>state.matMonture=v);
      renderChips("mat-branches", MATS, state.matBranches, (v)=>state.matBranches=v);
      renderDots("col-monture", state.colMonture, (v)=>state.colMonture=v, "ring ring-primary");
      renderDots("col-branches", state.colBranches, (v)=>state.colBranches=v, "ring ring-secondary");
      $("val-pont").textContent = String(state.largeurPont);
      $("val-verres").textContent = String(state.tailleVerres);
      $("sum-monture").textContent = state.matMonture;
      $("sum-branches").textContent = state.matBranches;
      $("sum-pont").textContent = String(state.largeurPont);
      $("sum-verres").textContent = String(state.tailleVerres);
      $("price").textContent = String(price());
      $("price-2").textContent = String(price());
    }

    $("pont").addEventListener("input", e=>{ state.largeurPont=+e.target.value; update(); });
    $("verres").addEventListener("input", e=>{ state.tailleVerres=+e.target.value; update(); });
    $("save").addEventListener("click", async ()=>{
      // TODO: branchement PB (fetch /api/saveSVG) si besoin
      const ok = true;
      if(ok) alert("Modèle sauvegardé");
    });

    update();
  </script>
</LayoutTaVue>
