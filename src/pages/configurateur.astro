---
import LayoutTaVue from "../layouts/LayoutTaVue.astro";

// SVG des lunettes int√©gr√© directement avec viewBox ajust√©
const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="50 100 500 200" width="100%" height="100%">
  <defs>
    <style>
      .cls-1 {
        fill: #706f6f;
        mix-blend-mode: multiply;
      }

      .cls-2 {
        isolation: isolate;
      }

      .cls-3, .cls-4 {
        fill: #ffffff;
      }

      .cls-4 {
        stroke: #1d1d1b;
        stroke-miterlimit: 10;
        stroke-width: .5px;
      }

      .cls-5 {
        fill: none;
        opacity: .75;
      }
    </style>
  </defs>
  <g class="cls-2">
    <g id="branches">
      <path class="cls-4" d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"/>
      <path class="cls-1" d="M308.24,150.76s-.31,6.15-3.98,5.57c-4.97-.78-35.82-33.83-46.17-32.24,0,0,8.53,2.71,18.46,11.64,6.51,5.86,34.42,37.85,31.69,15.03Z"/>
      <path class="cls-4" d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"/>
      <path class="cls-1" d="M381.34,180.1s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z"/>
      <path class="cls-1" d="M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z"/>
    </g>
    <g id="monture">
      <path class="cls-4" d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54ZM190.5,231.32c-9.42,5.1-32.18,7.06-46.31-3.92-14.13-10.99-20.8-30.22-22.76-52.98s7.1-25.23,7.1-25.23c0,0,14.88-.67,34.11,4.03,19.23,4.71,40.42,18.05,40.82,26.69.39,8.63-3.53,46.31-12.95,51.41ZM344.73,255.65c-9.03,4.32-21.47,4.71-31.93,3.92-10.46-.78-37.54-1.57-47.35-31.4,0,0-2.75-14.13-5.1-17.27-2.35-3.14-9.42-14.48-9.42-18.43,0-8.23,7.15-12.97,7.15-12.97,0,0,8.16-5.1,18.75-5.1,10.6,0,64.75,2.75,72.21,12.95,7.46,10.2,7.06,21.98,8.24,31.4,1.18,9.42-3.53,32.57-12.56,36.89Z"/>
    </g>
    <g id="verres">
      <path class="cls-5" d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"/>
      <path class="cls-5" d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"/>
    </g>
  </g>
</svg>`;
---

<LayoutTaVue title="Configurateur ‚Äî TaVue">
  <div class="max-w-7xl mx-auto px-6">
    <!-- En-t√™te de page -->
    <div class="mb-8">
      <h1 class="text-3xl font-serif font-semibold text-gray-900 mb-2">
        Configurateur de lunettes
      </h1>
      <p class="text-gray-600">
        Personnalisez votre monture en temps r√©el
      </p>
    </div>

    <!-- Layout principal -->
    <div class="grid lg:grid-cols-[1fr_400px] gap-8">
      
      <!-- COLONNE GAUCHE : Pr√©visualisation -->
      <section class="space-y-6">
        
        <!-- Card de pr√©visualisation -->
        <div class="card bg-white border border-gray-200 shadow-sm">
          <div class="card-body p-6">
            <!-- Tabs de vue -->
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-lg font-semibold text-gray-900">Pr√©visualisation</h2>
              <div class="tabs tabs-boxed">
                <a class="tab tab-active tab-sm">Face</a>
                <a class="tab tab-sm">Profil</a>
                <a class="tab tab-sm">3/4</a>
              </div>
            </div>

            <!-- Zone SVG -->
            <div class="aspect-[4/3] rounded-lg bg-gradient-to-br from-gray-50 to-gray-100 p-8 flex items-center justify-center">
              <div id="svg-host" class="w-full max-w-lg h-full flex items-center justify-center"></div>
            </div>

            <!-- Info mod√®le et prix -->
            <div class="flex items-center justify-between pt-6 border-t border-gray-200 mt-6">
              <div>
                <div class="text-sm text-gray-500 mb-1">Mod√®le</div>
                <div class="text-xl font-semibold text-gray-900" id="model-name">
                  TaVue Classic
                </div>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold text-gray-900">
                  <span id="price">289</span> ‚Ç¨
                </div>
                <div class="text-sm text-gray-500">TTC</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Card r√©sum√© de configuration -->
        <div class="card bg-white border border-gray-200 shadow-sm">
          <div class="card-body p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
              R√©sum√© de votre configuration
            </h3>
            <div class="space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Mat√©riau monture :</span>
                <span class="font-medium text-gray-900" id="sum-monture">Ac√©tate</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Couleur monture :</span>
                <span class="font-medium text-gray-900" id="sum-col-monture">Noir</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Mat√©riau branches :</span>
                <span class="font-medium text-gray-900" id="sum-branches">Ac√©tate</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Couleur branches :</span>
                <span class="font-medium text-gray-900" id="sum-col-branches">Marron</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Teinte verres :</span>
                <span class="font-medium text-gray-900" id="sum-col-verres">Transparent</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Largeur du pont :</span>
                <span class="font-medium text-gray-900"><span id="sum-pont">18</span> mm</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Taille des verres :</span>
                <span class="font-medium text-gray-900"><span id="sum-verres">52</span> mm</span>
              </div>
            </div>

            <!-- Actions -->
            <div class="pt-6 mt-6 border-t border-gray-200">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <div class="text-sm text-gray-500">Prix total</div>
                  <div class="text-2xl font-bold text-gray-900">
                    <span id="price-2">289</span> ‚Ç¨
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <button id="save" class="btn btn-outline btn-block">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Sauvegarder
                </button>
                <a href="/commande" class="btn btn-primary btn-block">
                  Commander
                </a>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- COLONNE DROITE : Options -->
      <aside class="space-y-6">
        
        <!-- Options de personnalisation -->
        <div class="card bg-white border border-gray-200 shadow-sm sticky top-20">
          <div class="card-body p-6 max-h-[calc(100vh-120px)] overflow-y-auto">
            <h2 class="text-lg font-semibold text-gray-900 mb-6">
              Options de personnalisation
            </h2>

            <!-- Mat√©riau monture -->
            <div class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-3">
                Mat√©riau de la monture
              </label>
              <div id="mat-monture" class="grid grid-cols-2 gap-2"></div>
            </div>

            <!-- Couleur monture -->
            <div class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-3">
                Couleur de la monture
              </label>
              <div id="col-monture" class="flex flex-wrap gap-3"></div>
            </div>

            <div class="divider"></div>

            <!-- Mat√©riau branches -->
            <div class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-3">
                Mat√©riau des branches
              </label>
              <div id="mat-branches" class="grid grid-cols-2 gap-2"></div>
            </div>

            <!-- Couleur branches -->
            <div class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-3">
                Couleur des branches
              </label>
              <div id="col-branches" class="flex flex-wrap gap-3"></div>
            </div>

            <div class="divider"></div>

            <!-- Teinte verres -->
            <div class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-3">
                Teinte des verres
              </label>
              <div id="col-verres" class="grid grid-cols-3 gap-3"></div>
            </div>

            <div class="divider"></div>

            <!-- Dimensions -->
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                  Largeur du pont : <span id="val-pont" class="text-[#2C3E50]">18</span> mm
                </label>
                <input 
                  id="pont" 
                  type="range" 
                  min="14" 
                  max="22" 
                  value="18" 
                  class="range range-sm w-full"
                />
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>14 mm</span>
                  <span>22 mm</span>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                  Taille des verres : <span id="val-verres" class="text-[#2C3E50]">52</span> mm
                </label>
                <input 
                  id="verres" 
                  type="range" 
                  min="48" 
                  max="58" 
                  value="52" 
                  class="range range-sm w-full"
                />
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>48 mm</span>
                  <span>58 mm</span>
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <!-- IA Generation -->
            <!-- REMPLACEZ CETTE SECTION DANS VOTRE CONFIGURATEUR.ASTRO -->
<!-- Cherchez la section "IA Generation" et remplacez-la par ce code -->

<div class="divider"></div>

<!-- IA Generation -->
<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-5 border border-gray-200">
  <div class="flex items-start gap-3 mb-4">
    <div class="p-2 bg-[#2C3E50] rounded-lg">
      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
    </div>
    <div class="flex-1">
      <h4 class="font-semibold text-gray-900 text-sm mb-1">
        G√©n√©ration par IA
      </h4>
      <p class="text-xs text-gray-600">
        D√©crivez vos pr√©f√©rences et laissez l'IA cr√©er votre monture id√©ale
      </p>
    </div>
  </div>
  
  <!-- Exemples de prompts (optionnel - √† d√©commenter si d√©sir√©) -->
  <!--
  <details class="mb-3">
    <summary class="text-xs text-gray-600 cursor-pointer hover:text-gray-900 mb-2">
      üí° Voir des exemples de descriptions
    </summary>
    <div class="space-y-1 ml-4">
      <button 
        class="text-xs text-left text-gray-600 hover:text-[#2C3E50] hover:underline block w-full"
        onclick="document.getElementById('ai-prompt-input').value = 'Lunettes rondes vintage en m√©tal dor√© avec verres teint√©s marron'"
      >
        ‚Üí Lunettes rondes vintage en m√©tal dor√©
      </button>
      <button 
        class="text-xs text-left text-gray-600 hover:text-[#2C3E50] hover:underline block w-full"
        onclick="document.getElementById('ai-prompt-input').value = 'Monture rectangulaire moderne en ac√©tate noir mat'"
      >
        ‚Üí Monture rectangulaire moderne
      </button>
      <button 
        class="text-xs text-left text-gray-600 hover:text-[#2C3E50] hover:underline block w-full"
        onclick="document.getElementById('ai-prompt-input').value = 'Design minimaliste en titane argent√© avec branches fines'"
      >
        ‚Üí Design minimaliste en titane
      </button>
      <button 
        class="text-xs text-left text-gray-600 hover:text-[#2C3E50] hover:underline block w-full"
        onclick="document.getElementById('ai-prompt-input').value = 'Style cat-eye ann√©es 50 en ac√©tate rouge bordeaux'"
      >
        ‚Üí Style cat-eye ann√©es 50
      </button>
    </div>
  </details>
  -->
  
  <!-- Zone de saisie -->
  <textarea 
    id="ai-prompt-input"
    class="textarea textarea-bordered w-full text-sm mb-3" 
    placeholder="Ex : une monture √©l√©gante pour le bureau, avec des tons chauds..."
    rows="3"
  ></textarea>
  
  <!-- Bouton de g√©n√©ration -->
  <button id="ai-generate-btn" class="btn btn-sm btn-primary btn-block">
    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
    </svg>
    G√©n√©rer avec l'IA
  </button>
  
  <!-- Zone de chargement -->
  <div id="ai-loading" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
    <div class="flex items-center gap-3">
      <span class="loading loading-spinner loading-sm text-[#2C3E50]"></span>
      <span class="text-xs text-gray-700">L'IA g√©n√®re votre monture...</span>
    </div>
  </div>

  <!-- Zone d'erreur -->
  <div id="ai-error" class="hidden mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
    <div class="flex items-start gap-2">
      <svg class="w-4 h-4 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <p class="text-xs text-red-800" id="ai-error-message"></p>
    </div>
  </div>

  <!-- Zone de succ√®s -->
  <div id="ai-success" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
    <div class="flex items-start gap-2">
      <svg class="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <p class="text-xs text-green-800">Monture g√©n√©r√©e ! Vous pouvez maintenant la personnaliser.</p>
    </div>
  </div>
</div>

  <!-- Script de configuration -->
  <script define:vars={{ svgContent }}>
    const COLORS = [
      { hex: "#1A1A1A", name: "Noir" },
      { hex: "#8B7355", name: "Marron Cognac" },
      { hex: "#2C3E50", name: "Bleu Marine" },
      { hex: "#C9A885", name: "Beige Dor√©" },
      { hex: "#FFFFFF", name: "Blanc" },
      { hex: "#DC2626", name: "Rouge" },
      { hex: "#059669", name: "Vert Sapin" },
      { hex: "#1E3A8A", name: "Bleu Royal" }
    ];

    const COLORS_VERRES = [
      { hex: "rgba(255,255,255,0.1)", name: "Transparent", price: 0 },
      { hex: "rgba(0,0,0,0.2)", name: "Gris L√©ger", price: 15 },
      { hex: "rgba(0,0,0,0.5)", name: "Gris Fonc√©", price: 20 },
      { hex: "rgba(139,69,19,0.3)", name: "Marron", price: 20 },
      { hex: "rgba(0,100,0,0.3)", name: "Vert", price: 25 },
      { hex: "rgba(0,0,139,0.3)", name: "Bleu", price: 25 },
      { hex: "rgba(255,105,180,0.3)", name: "Rose", price: 25 },
      { hex: "rgba(255,165,0,0.3)", name: "Orange", price: 25 }
    ];
    
    const MATS = ["Ac√©tate", "M√©tal", "Titane", "Bois"];
    
    const SURCHARGES = {
      "Ac√©tate": { m: 0, b: 0 },
      "M√©tal": { m: 30, b: 20 },
      "Titane": { m: 60, b: 40 },
      "Bois": { m: 45, b: 35 }
    };

    const state = {
      base: 289,
      matMonture: "Ac√©tate",
      matBranches: "Ac√©tate",
      colMonture: COLORS[0].hex,
      colMontureNom: COLORS[0].name,
      colBranches: COLORS[1].hex,
      colBranchesNom: COLORS[1].name,
      colVerres: COLORS_VERRES[0].hex,
      colVerresNom: COLORS_VERRES[0].name,
      largeurPont: 18,
      tailleVerres: 52,
      svg: svgContent
    };

    const $ = (id) => document.getElementById(id);
    
    function price() {
      const verresPrice = COLORS_VERRES.find(c => c.hex === state.colVerres)?.price || 0;
      return state.base + 
        (SURCHARGES[state.matMonture].m || 0) + 
        (SURCHARGES[state.matBranches].b || 0) +
        verresPrice;
    }

    function injectSVG() {
      const host = $("svg-host");
      host.innerHTML = state.svg;
      
      // Applique les couleurs au SVG
      const svg = host.querySelector("svg");
      if (svg) {
        svg.style.maxWidth = "100%";
        svg.style.height = "auto";
        
        // Style pour la monture
        const montureElements = svg.querySelectorAll("#monture path");
        montureElements.forEach(el => {
          if (el.classList.contains('cls-4')) {
            el.style.fill = state.colMonture;
            el.style.stroke = state.colMonture;
          }
        });

        // Style pour les branches
        const branchesElements = svg.querySelectorAll("#branches path");
        branchesElements.forEach(el => {
          if (el.classList.contains('cls-4')) {
            el.style.fill = state.colBranches;
            el.style.stroke = state.colBranches;
          }
        });

        // Style pour les verres
        const verresElements = svg.querySelectorAll("#verres path");
        verresElements.forEach(el => {
          if (el.classList.contains('cls-5')) {
            el.style.fill = state.colVerres;
            el.style.opacity = "1";
          }
        });
      }
    }

    function renderMaterialButtons(containerId, current, onPick) {
      const box = $(containerId);
      box.innerHTML = "";
      MATS.forEach(mat => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `btn btn-sm ${current === mat ? "btn-primary" : "btn-outline"}`;
        btn.textContent = mat;
        btn.onclick = () => {
          onPick(mat);
          update();
        };
        box.appendChild(btn);
      });
    }

    function renderColorSwatches(containerId, current, onPick, colorArray = COLORS) {
      const box = $(containerId);
      box.innerHTML = "";
      colorArray.forEach(color => {
        const swatch = document.createElement("button");
        swatch.type = "button";
        swatch.className = `w-10 h-10 rounded-full transition-all ${
          current === color.hex 
            ? "ring-4 ring-[#2C3E50] ring-offset-2 scale-110" 
            : "ring-1 ring-gray-300 hover:scale-105"
        }`;
        swatch.style.backgroundColor = color.hex;
        swatch.title = color.name;
        swatch.onclick = () => {
          onPick(color);
          update();
        };
        box.appendChild(swatch);
      });
    }

    function renderVerresSwatches() {
      const box = $("col-verres");
      box.innerHTML = "";
      COLORS_VERRES.forEach(color => {
        const container = document.createElement("div");
        container.className = "text-center";
        
        const swatch = document.createElement("button");
        swatch.type = "button";
        swatch.className = `w-full aspect-square rounded-lg transition-all ${
          state.colVerres === color.hex 
            ? "ring-4 ring-[#2C3E50] ring-offset-2 scale-105" 
            : "ring-1 ring-gray-300 hover:scale-105"
        }`;
        swatch.style.backgroundColor = color.hex;
        swatch.title = color.name;
        swatch.onclick = () => {
          state.colVerres = color.hex;
          state.colVerresNom = color.name;
          update();
        };
        
        const label = document.createElement("div");
        label.className = "text-xs text-gray-600 mt-1";
        label.textContent = color.name;
        
        const priceLabel = document.createElement("div");
        priceLabel.className = "text-xs font-semibold text-[#2C3E50]";
        priceLabel.textContent = color.price > 0 ? `+${color.price}‚Ç¨` : "Inclus";
        
        container.appendChild(swatch);
        container.appendChild(label);
        container.appendChild(priceLabel);
        box.appendChild(container);
      });
    }

    function update() {
      injectSVG();
      
      // Materials
      renderMaterialButtons("mat-monture", state.matMonture, (v) => state.matMonture = v);
      renderMaterialButtons("mat-branches", state.matBranches, (v) => state.matBranches = v);
      
      // Colors
      renderColorSwatches("col-monture", state.colMonture, (c) => {
        state.colMonture = c.hex;
        state.colMontureNom = c.name;
      });
      renderColorSwatches("col-branches", state.colBranches, (c) => {
        state.colBranches = c.hex;
        state.colBranchesNom = c.name;
      });
      
      // Verres
      renderVerresSwatches();
      
      // Dimensions
      $("val-pont").textContent = String(state.largeurPont);
      $("val-verres").textContent = String(state.tailleVerres);
      
      // Summary
      $("sum-monture").textContent = state.matMonture;
      $("sum-col-monture").textContent = state.colMontureNom;
      $("sum-branches").textContent = state.matBranches;
      $("sum-col-branches").textContent = state.colBranchesNom;
      $("sum-col-verres").textContent = state.colVerresNom;
      $("sum-pont").textContent = String(state.largeurPont);
      $("sum-verres").textContent = String(state.tailleVerres);
      
      // Price
      const currentPrice = price();
      $("price").textContent = String(currentPrice);
      $("price-2").textContent = String(currentPrice);
    }

    // Event listeners
    $("pont").addEventListener("input", (e) => {
      state.largeurPont = +e.target.value;
      update();
    });

    $("verres").addEventListener("input", (e) => {
      state.tailleVerres = +e.target.value;
      update();
    });

    $("save").addEventListener("click", async () => {
      try {
        const nomModele = prompt("Donnez un nom √† votre mod√®le :", "TaVue Custom");
        
        if (!nomModele) {
          alert("Vous devez donner un nom au mod√®le pour le sauvegarder.");
          return;
        }
        
        const host = $("svg-host");
        const svgCopy = host.innerHTML;
        
        const modelData = {
          nom_modele: nomModele.trim(),
          materiau_monture: state.matMonture,
          couleur_monture: state.colMontureNom,
          materiau_branches: state.matBranches,
          couleur_branches: state.colBranchesNom,
          couleur_verres: state.colVerresNom,
          largeur_pont: state.largeurPont,
          taille_verres: state.tailleVerres,
          prix_total: price(),
          svg_code: svgCopy
        };

        const response = await fetch('/api/saveSVG', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(modelData)
        });

        if (response.ok) {
          const result = await response.json();
          alert("‚úì Mod√®le sauvegard√© dans votre collection");
          setTimeout(() => {
            window.location.href = "/mes-modeles";
          }, 1000);
        } else {
          const error = await response.text();
          alert("‚ùå Erreur lors de la sauvegarde : " + error);
        }
      } catch (error) {
        console.error("Erreur:", error);
        alert("‚ùå Erreur lors de la sauvegarde. V√©rifiez que vous √™tes connect√©.");
      }
    });

    // Initialize
    update();

    // Charger un mod√®le si l'ID est dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const loadId = urlParams.get('load');
    
    if (loadId) {
      fetch(`/api/getModel?id=${loadId}`)
        .then(res => res.json())
        .then(data => {
          if (data) {
            state.matMonture = data.materiau_monture || "Ac√©tate";
            state.matBranches = data.materiau_branches || "Ac√©tate";
            
            const montureColor = COLORS.find(c => c.name === data.couleur_monture) || COLORS[0];
            const branchesColor = COLORS.find(c => c.name === data.couleur_branches) || COLORS[1];
            const verresColor = COLORS_VERRES.find(c => c.name === data.couleur_verres) || COLORS_VERRES[0];
            
            state.colMonture = montureColor.hex;
            state.colMontureNom = montureColor.name;
            state.colBranches = branchesColor.hex;
            state.colBranchesNom = branchesColor.name;
            state.colVerres = verresColor.hex;
            state.colVerresNom = verresColor.name;
            
            state.largeurPont = data.largeur_pont || 18;
            state.tailleVerres = data.taille_verres || 52;
            
            $("pont").value = state.largeurPont;
            $("verres").value = state.tailleVerres;
            
            $("model-name").textContent = data.nom_modele || "TaVue Custom";
            
            update();
          }
        })
        .catch(err => console.error("Erreur chargement mod√®le:", err));
    }
  </script>
</LayoutTaVue>